<div class="add-task-container" [ngClass]="{ 'dialog-mode': isDialogMode }">
  <h2 class="add-task-heading">Add Task</h2>
  <div class="add-task-section">

    <!-- LEFT -->
    <div class="add-task-left">

      <!-- Title -->
      <div class="form-group">
        <label for="title">Title<span class="required">*</span></label>
        <input
          id="title"
          type="text"
          placeholder="Enter a title"
          [(ngModel)]="title"
          (blur)="validateTitle()"
          required
        />
        <p class="error-message" [style.visibility]="titleInvalid ? 'visible' : 'hidden'">
          This field is required
        </p>
      </div>

      <!-- Description -->
      <div class="form-group assigned-to-fixed">
        <label for="description">Description</label>
        <textarea
          id="description"
          rows="4"
          placeholder="Enter a description"
          [(ngModel)]="description"
        ></textarea>
      </div>

      <!-- Due Date -->
      <div class="form-group">
        <label for="dueDate">Due date<span class="required">*</span></label>
        <input
          id="dueDate"
          type="date"
          [min]="today"
          [(ngModel)]="dueDate"
          (blur)="validateDueDate()"
          (change)="validateDueDate()"
          required
        />
        <p class="error-message" [style.visibility]="dueDateInvalid ? 'visible' : 'hidden'">
          This field is required
        </p>
      </div>

    </div>

    <div class="devide-section" aria-hidden="true"></div>

    <!-- RIGHT -->
    <div class="add-task-right">

      <!-- PRIORITY -->
      <div class="form-group">
        <label>Priority</label>
        <div class="priority-buttons">
          <button
            type="button"
            class="priority urgent"
            [class.active]="priority==='urgent'"
            (click)="setPriority('urgent')"
          >
            <span>Urgent</span>
            <img
              [attr.src]="
                priority === 'urgent'
                  ? 'assets/imgs/add-task/urgent_white.png'
                  : 'assets/imgs/add-task/urgent_default.png'
              "
              alt="Urgent"
            />
          </button>
          <button
            type="button"
            class="priority medium"
            [class.active]="priority==='medium'"
            (click)="setPriority('medium')"
          >
            <span>Medium</span>
            <img
              [attr.src]="
                priority === 'medium'
                  ? 'assets/imgs/add-task/medium_white.png'
                  : 'assets/imgs/add-task/medium_default.png'
              "
              alt="Medium"
            />
          </button>
          <button
            type="button"
            class="priority low"
            [class.active]="priority==='low'"
            (click)="setPriority('low')"
          >
            <span>Low</span>
            <img
              [attr.src]="
                priority === 'low'
                  ? 'assets/imgs/add-task/low_white.png'
                  : 'assets/imgs/add-task/low_default.png'
              "
              alt="Low"
            />
          </button>
        </div>
      </div>

      <!-- ASSIGNED TO MULTISELECT -->
      <div class="form-group">
        <label>Assigned To</label>
        <app-assigned-to-select
          [contacts]="allContacts"
          [(selectedContacts)]="assignedToContacts"
        ></app-assigned-to-select>
      </div>

      <!-- CATEGORY -->
      <div class="category-select form-group">
        <label>Category<span class="required">*</span></label>
        <div class="category-dropdown-custom" (click)="toggleCategoryDropdown()">
          <span class="category-selected">{{ category || 'Select task category' }}</span>
          <img
            [src]="
              isCategoryDropdownOpen
                ? 'assets/imgs/add-task/arrow_drop_up.png'
                : 'assets/imgs/add-task/arrow_drop_down.png'
            "
            class="dropdown-arrow"
            (click)="toggleCategoryDropdown($event)"
            alt="Dropdown Arrow"
          />
          <div class="category-options" *ngIf="isCategoryDropdownOpen">
            <div class="category-option" (click)="selectCategory('User Story', $event)">
              User Story
            </div>
            <div class="category-option" (click)="selectCategory('Technical Task', $event)">
              Technical Task
            </div>
          </div>
        </div>
        <p class="error-message" *ngIf="categoryInvalid">This field is required</p>
      </div>

      <!-- SUBTASKS -->
      <div class="form-group">
        <label>Subtasks</label>
        <div class="subtask-input" >
          <input
            type="text"
            placeholder="Add new subtask"
            [(ngModel)]="newSubtask"
            (keyup.enter)="addSubtask()"
            (click)="$event.stopPropagation()"
            style="height: 48px;"
          />
          <div class="subtask-actions">
            <img
              src="assets/imgs/add-task/delete_grey.png"
              alt="Clear subtask"
              class="subtask-icon delete"
              (mousedown)="$event.preventDefault()"
              (click)="newSubtask = ''"
              style="width: 24px; height: 24px;"
            />
            <div class="subtask-divider"></div>
            <img
              src="assets/imgs/add-task/check_grey.png"
              alt="Add subtask"
              class="subtask-icon check"
              (mousedown)="$event.preventDefault()"
              (click)="addSubtask()"
              style="width: 24px; height: 24px;"
            />
          </div>
        </div>

        <div class="subtask-list-container">
          <div class="subtask-list">
            <div
              *ngFor="let task of subtasks; let i = index"
              class="subtask-item"
              [class.editing]="editingSubtaskIndex === i"
              style="display: flex; align-items: center; position: relative; height: 48px;"
            >
              <ng-container *ngIf="editingSubtaskIndex === i; else viewSubtask">
                <div class="subtask-input existing-subtask" style="flex: 1; display: flex; align-items: center; height: 48px;">
                  <input
                    type="text"
                    [(ngModel)]="editingSubtaskTitle"
                    (click)="$event.stopPropagation()"
                    (keyup.enter)="saveSubtaskEdit(i)"
                    style="flex: 1; height: 48px;"
                  />
                  <div class="subtask-actions" style="margin-left: 8px; display: flex; align-items: center;">
                    <img
                      src="assets/imgs/add-task/trash.png"
                      alt="Delete subtask"
                      class="subtask-icon delete"
                      (mousedown)="$event.preventDefault()"
                      (click)="$event.stopPropagation(); removeSubtask(i)"
                    />
                    <div class="subtask-divider" style="width: 1px; height: 20px; background: #A8A8A8; margin: 0 8px;"></div>
                    <img
                      src="assets/imgs/add-task/check_grey.png"
                      alt="Save subtask"
                      class="subtask-icon check"
                      (mousedown)="$event.preventDefault()"
                      (click)="$event.stopPropagation(); saveSubtaskEdit(i)"
                    />
                  </div>
                </div>
              </ng-container>

              <ng-template #viewSubtask>
                <span style="font-size: 20px; margin-right: 8px;">&bull;</span>
                <span
                  class="subtask-title-text"
                  style="flex: 1; cursor: pointer;"
                  (click)="startEditSubtask(i, task.title)"
                >
                  {{ task.title }}
                </span>
                <div class="subtask-actions" style="margin-left: 8px; display: flex; align-items: center;">
                  <img
                    src="assets/imgs/add-task/edit.png"
                    alt="Bearbeiten"
                    class="subtask-icon edit"
                    (click)="startEditSubtask(i, task.title)"
                  />
                  <div class="subtask-divider" style="width: 1px; height: 20px; background: #A8A8A8; margin: 0 8px;"></div>
                  <img
                    src="assets/imgs/add-task/trash.png"
                    alt="Löschen"
                    class="subtask-icon delete"
                    (click)="removeSubtask(i)"
                  />
                </div>
              </ng-template>
            </div>
          </div>
        </div>

        <p class="inline-required-hint-right"><span class="required">*</span>This field is required</p>
      </div>

    </div>
  </div>

  <!-- ACTION BUTTONS -->
  <div class="text-button-div">
    <p class="inline-required-hint"><span class="required">*</span>This field is required</p>
    <div class="action-buttons">
      <button type="button" class="clear-btn" (click)="clearForm()">Clear ✕</button>
      <button
        type="button"
        class="create-btn"
        [disabled]="!isFormValid"
        (click)="createTask()"
      >
        Create Task ✓
      </button>
    </div>
  </div>

  <!-- SUCCESS MESSAGE -->
  <div class="task-saved-message center-animate" *ngIf="taskSavedMessage">
    Task added to board! <img class="board-icon" src="assets/imgs/add-task/board-icon.png" alt="Success" />
  </div>
</div>