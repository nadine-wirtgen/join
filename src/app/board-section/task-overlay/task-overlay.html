<div class="overlay-backdrop" (click)="onClose()">
  <div class="task-overlay" (click)="$event.stopPropagation()">
    <!-- ====================== VIEW MODE ====================== -->
    <div *ngIf="!isEditMode && task" class="task-view-container">
      <div class="overlay-header">
        <button class="close-btn" (click)="onClose()">✕</button>

        <div class="category-badge" [style.background-color]="categoryColor">
          {{ safeTask.category }}
        </div>

        <h1 class="task-title" [title]="safeTask.title">
          {{ safeTask.title.length > 20 ? (safeTask.title | slice: 0 : 20) + '…' : safeTask.title }}
        </h1>

        <p class="task-description">
          {{ safeTask.description }}
        </p>
      </div>

      <div class="overlay-content">
        <!-- INFO GRID -->
        <div class="info-grid">
          <div class="info-row">
            <span class="label">Due date:</span>
            <span class="value">{{ safeTask.dueDate | date: 'dd/MM/yyyy' }}</span>
          </div>

          <div class="info-row">
            <span class="label">Priority:</span>
            <div class="priority-badge" [ngClass]="safeTask.priority">
              <span>{{ safeTask.priority | titlecase }}</span>
              <img [src]="'assets/imgs/add-task/' + safeTask.priority + '_default.png'" />
            </div>
          </div>
        </div>

        <!-- ASSIGNED TO -->
        <div class="assigned-section">
          <span class="label">Assigned To:</span>

          <div class="contacts-list">
            <div *ngIf="assignedContacts.length; else noContacts" class="assigned-list scrollable">
              <div
                *ngFor="let contact of assignedContacts; trackBy: trackByContactId"
                class="assigned-item"
              >
                <div class="avatar" [style.background-color]="getContactColor(contact)">
                  {{ getInitials(contact.name) }}
                </div>
                <span class="contact-name">{{ contact.name }}</span>
              </div>
            </div>

            <ng-template #noContacts>
              <div class="empty-state">No contacts assigned</div>
            </ng-template>
          </div>
        </div>

        <!-- SUBTASKS VIEW -->
        <div class="form-group">
          <label>Subtasks</label>
          <div class="subtasks-list-view">
            <div
              *ngFor="let subtask of task.subtasks; let i = index"
              class="subtask-item clickable"
              (click)="toggleSubtask(subtask)"
            >
              <img
                class="subtask-checkbox-img"
                [src]="
                  'assets/imgs/add-task/' +
                  (subtask.completed ? 'checkbox-checked.png' : 'check_unchecked.png')
                "
              />
              <span class="subtask-title-text">{{ subtask.title }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- FOOTER VIEW -->
      <div class="overlay-footer">
        <button class="delete-btn" (click)="onDelete()">
          <img src="assets/icon/contact-info/delete-default.png" class="btn-icon" />
          Delete
        </button>

        <div class="divider"></div>

        <button class="edit-btn" (click)="enableEdit()">
          <img src="assets/icon/contact-info/edit-default.png" class="btn-icon" />
          Edit
        </button>
      </div>
    </div>

    <!-- ====================== EDIT MODE ====================== -->
    <div *ngIf="isEditMode && task" class="task-edit-container">
      <div class="overlay-header">
        <button class="close-btn" (click)="onClose()">✕</button>
      </div>

      <div class="overlay-content">
        <form #taskForm="ngForm" (ngSubmit)="onSave()" novalidate>
          <!-- TITLE -->
          <div class="form-group">
            <label>Title</label>
            <input type="text" [(ngModel)]="editedTask.title" name="title" required />
          </div>

          <!-- DESCRIPTION -->
          <div class="form-group">
            <label>Description</label>
            <textarea [(ngModel)]="editedTask.description" name="description"></textarea>
          </div>

          <!-- DUE DATE -->
          <div class="form-group date-picker" (click)="openDatePicker(dateInput)">
            <label>Due date</label>
            <input
              #dateInput
              type="date"
              [(ngModel)]="editedTask.dueDate"
              name="dueDate"
              [min]="today"
              required
            />
          </div>

          <!-- PRIORITY -->
          <div class="form-group">
            <label>Priority</label>
            <div class="priority-buttons">
              <button
                type="button"
                class="priority urgent"
                [class.active]="editedTask.priority === 'urgent'"
                (click)="editedTask.priority = 'urgent'"
              >
                <span>Urgent</span>
                <img
                  [src]="
                    editedTask.priority === 'urgent'
                      ? 'assets/imgs/add-task/urgent_white.png'
                      : 'assets/imgs/add-task/urgent_default.png'
                  "
                  alt="Urgent"
                />
              </button>

              <button
                type="button"
                class="priority medium"
                [class.active]="editedTask.priority === 'medium'"
                (click)="editedTask.priority = 'medium'"
              >
                <span>Medium</span>
                <img
                  [src]="
                    editedTask.priority === 'medium'
                      ? 'assets/imgs/add-task/medium_white.png'
                      : 'assets/imgs/add-task/medium_default.png'
                  "
                  alt="Medium"
                />
              </button>

              <button
                type="button"
                class="priority low"
                [class.active]="editedTask.priority === 'low'"
                (click)="editedTask.priority = 'low'"
              >
                <span>Low</span>
                <img
                  [src]="
                    editedTask.priority === 'low'
                      ? 'assets/imgs/add-task/low_white.png'
                      : 'assets/imgs/add-task/low_default.png'
                  "
                  alt="Low"
                />
              </button>
            </div>
          </div>

          <!-- ASSIGNED TO (Contact Selector eingebunden) -->
          <div class="form-group">
            <label>Assigned to</label>
            <app-contact-selector
              [contacts]="contactService.contactList"
              [selectedContactNames]="editedTask.assignedTo || []"
              (selectedContactsChange)="onContactsChange($event)"
            >
            </app-contact-selector>
          </div>

          <!-- SUBTASKS EDIT -->
          <div class="form-group">
            <label>Subtasks</label>

            <!-- NEW SUBTASK -->
            <div class="subtask-input">
              <input
                type="text"
                [(ngModel)]="newSubtaskTitle"
                name="newSubtask"
                placeholder="Add new subtask"
                (keyup.enter)="addSubtask()"
              />

              <div class="subtask-actions">
                <img
                  src="assets/imgs/add-task/delete_grey.png"
                  class="subtask-icon delete"
                  (click)="newSubtaskTitle = ''"
                />

                <div class="subtask-divider"></div>

                <img
                  src="assets/imgs/add-task/check_grey.png"
                  class="subtask-icon check"
                  (click)="addSubtask()"
                />
              </div>
            </div>

            <!-- EXISTING SUBTASKS -->
            <div class="subtask-list-container">
              <div class="subtask-list">
                <div
                  *ngFor="let subtask of editedTask.subtasks; let i = index"
                  class="subtask-item clickable"
                  [class.editing]="editingSubtaskIndex === i"
                  (click)="startSubtaskEdit(i)"
                  (mouseenter)="hoveredSubtaskIndex = i"
                  (mouseleave)="hoveredSubtaskIndex = null"
                >
                  <span class="subtask-bullet" *ngIf="editingSubtaskIndex !== i">•</span>

                  <!-- EDIT MODE -->
                  <ng-container *ngIf="editingSubtaskIndex === i; else viewMode">
                    <input
                      type="text"
                      [(ngModel)]="subtask.title"
                      name="subtask-{{ i }}"
                      class="edit-input"
                      (click)="$event.stopPropagation()"
                      (keyup)="handleSubtaskKey($event, i)"
                    />

                    <div class="subtask-actions">
                      <img
                        src="assets/imgs/add-task/trash.png"
                        class="subtask-icon delete"
                        (click)="cancelSubtaskEdit(); $event.stopPropagation()"
                      />

                      <div class="subtask-divider"></div>

                      <img
                        src="assets/imgs/add-task/check_grey.png"
                        class="subtask-icon check"
                        (click)="saveSubtaskEdit(i); $event.stopPropagation()"
                      />
                    </div>
                  </ng-container>

                  <!-- NORMAL VIEW -->
                  <ng-template #viewMode>
                    <span class="subtask-title-text">{{ subtask.title }}</span>

                    <div class="subtask-actions" *ngIf="hoveredSubtaskIndex === i">
                      <img
                        src="assets/imgs/add-task/edit.png"
                        class="subtask-icon edit"
                        (click)="startSubtaskEdit(i); $event.stopPropagation()"
                      />

                      <div class="subtask-divider"></div>

                      <img
                        src="assets/imgs/add-task/trash.png"
                        class="subtask-icon delete"
                        (click)="removeSubtask(i); $event.stopPropagation()"
                      />
                    </div>
                  </ng-template>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- FOOTER EDIT -->
      <div class="overlay-footer">
        <button
          type="submit"
          class="save-btn"
          (click)="taskForm.ngSubmit.emit()"
          [disabled]="taskForm.invalid || isSaving"
        >
          {{ isSaving ? 'Saving...' : 'Ok ✓' }}
        </button>
      </div>
    </div>
  </div>
</div>
