<div class="overlay-backdrop" (click)="onClose()">
  <div class="task-overlay" (click)="$event.stopPropagation()">
    @if (!isEditMode && task) {
      <div class="task-view-container">
        <button class="close-btn" (click)="onClose()">‚úï</button>

        <div class="category-badge" [style.background-color]="categoryColor">
          {{ safeTask.category }}
        </div>

        <h1 class="task-title">{{ safeTask.title }}</h1>

        <p class="task-description">{{ safeTask.description }}</p>

        <div class="info-grid">
          <div class="info-row">
            <span class="label">Due date:</span>
            <span class="value">{{ safeTask.dueDate | date: 'dd/MM/yyyy' }}</span>
          </div>

          <div class="info-row">
            <span class="label">Priority:</span>
            <div class="priority-badge" [ngClass]="safeTask.priority">
              <span>{{ safeTask.priority | titlecase }}</span>
              <span class="priority-icon">
                @if (safeTask.priority === 'urgent') {
                  ‚ñ≤
                } @else if (safeTask.priority === 'medium') {
                  =
                } @else {
                  ‚ñº
                }
              </span>
            </div>
          </div>
        </div>

        <div class="assigned-section">
          <span class="label">Assigned To:</span>
          <div class="contacts-list">
            @if (assignedContacts && assignedContacts.length > 0) {
              <div class="assigned-badges">
                @for (contact of displayedAssignedInView; track contact.id) {
                  <div class="contact-badge">
                    <div class="avatar" [style.background-color]="getContactColor(contact)">
                      {{ getInitials(contact.name) }}
                    </div>
                    <span class="contact-name">{{ contact.name }}</span>
                  </div>
                }

                @if (hiddenAssignedInViewCount > 0 && !showAllAssignedInView) {
                  <div class="more-badge" (click)="toggleAssignedInView()">
                    +{{ hiddenAssignedInViewCount }}
                  </div>
                }

                @if (showAllAssignedInView && assignedContacts.length > 3) {
                  <div class="more-badge less-badge" (click)="toggleAssignedInView()">
                    ‚àí{{ assignedContacts.length - 3 }}
                  </div>
                }
              </div>
            } @else {
              <div class="empty-state">No contacts assigned</div>
            }
          </div>
        </div>

        <div class="form-group">
          <label>Subtasks</label>

          @if (safeTask.subtasks && safeTask.subtasks.length > 0) {
            <div class="subtasks-list">
              @for (subtask of safeTask.subtasks.slice(0, 3); track subtask; let i = $index) {
                <div
                  class="subtask-item"
                  (mouseenter)="hoveredSubtaskIndex = i"
                  (mouseleave)="hoveredSubtaskIndex = null"
                >
                  <input
                    type="checkbox"
                    [checked]="subtask.completed"
                    (change)="toggleSubtask(subtask)"
                    class="subtask-checkbox"
                  />
                  <span class="subtask-title" [class.completed]="subtask.completed">
                    {{ subtask.title }}
                  </span>
                </div>
              }

              @if (safeTask.subtasks.length > 3) {
                <div class="more-subtasks">
                  <button
                    type="button"
                    class="more-btn"
                    (click)="showAllSubtasksView = !showAllSubtasksView"
                  >
                    <span class="plus-icon">{{ showAllSubtasksView ? '‚àí' : '+' }}</span>
                    <span>{{
                      showAllSubtasksView ? 'Show less' : safeTask.subtasks.length - 3 + ' more'
                    }}</span>
                  </button>
                </div>
              }

              @if (showAllSubtasksView) {
                <div class="extra-subtasks">
                  @for (subtask of safeTask.subtasks.slice(3); track subtask; let i = $index) {
                    <div
                      class="subtask-item"
                      (mouseenter)="hoveredSubtaskIndex = i + 3"
                      (mouseleave)="hoveredSubtaskIndex = null"
                    >
                      <input
                        type="checkbox"
                        [checked]="subtask.completed"
                        (change)="toggleSubtask(subtask)"
                        class="subtask-checkbox"
                      />
                      <span class="subtask-title" [class.completed]="subtask.completed">
                        {{ subtask.title }}
                      </span>

                      @if (hoveredSubtaskIndex === i + 3) {
                        <div class="subtask-actions">
                          <button class="delete-subtask" (click)="removeSubtask(i + 3)">
                            <img src="assets/icon/task/delete-default.png" alt="delete" />
                          </button>
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          } @else {
            <div class="empty-state">No subtasks</div>
          }
        </div>

        <div class="overlay-footer">
          <button class="delete-btn" (click)="onDelete()">
            <span class="btn-icon">üóë</span>
            Delete
          </button>
          <div class="divider"></div>
          <button class="edit-btn" (click)="enableEdit()">
            <span class="btn-icon">‚úè</span>
            Edit
          </button>
        </div>
      </div>
    }

    @if (isEditMode && task) {
      <div class="task-edit-container">
        <button class="close-btn" (click)="cancelEdit()">‚úï</button>

        <form #taskForm="ngForm" (ngSubmit)="onSave()" novalidate>
          <div class="edit-content">
            <div class="form-group" [class.has-error]="title.invalid && title.touched">
              <label>Title <span class="required">*</span></label>
              <input
                type="text"
                [(ngModel)]="editedTask.title"
                name="title"
                #title="ngModel"
                required
                placeholder="Enter task title"
              />
              @if (title.invalid && title.touched) {
                <small class="error-message">Title is required</small>
              }
            </div>

            <div class="form-group">
              <label>Description</label>
              <textarea
                [(ngModel)]="editedTask.description"
                name="description"
                #description="ngModel"
                placeholder="Enter task description"
              ></textarea>
            </div>

            <div class="form-group" [class.has-error]="dueDate.invalid && dueDate.touched">
              <label>Due date <span class="required">*</span></label>
              <input
                type="date"
                [(ngModel)]="editedTask.dueDate"
                name="dueDate"
                #dueDate="ngModel"
                required
                [min]="today"
              />
              @if (dueDate.invalid && dueDate.touched) {
                @if (dueDate.errors?.['required']) {
                  <small class="error-message">Due date is required</small>
                }
                @if (dueDate.errors?.['min']) {
                  <small class="error-message">Due date must be in the future</small>
                }
              }
            </div>

            <div class="form-group">
              <label>Priority</label>
              <div class="priority-selector">
                <button
                  type="button"
                  class="priority-btn urgent"
                  [class.active]="editedTask.priority === 'urgent'"
                  (click)="setPriority('urgent')"
                >
                  Urgent <span class="icon">‚ñ≤</span>
                </button>
                <button
                  type="button"
                  class="priority-btn medium"
                  [class.active]="editedTask.priority === 'medium'"
                  (click)="setPriority('medium')"
                >
                  Medium <span class="icon">=</span>
                </button>
                <button
                  type="button"
                  class="priority-btn low"
                  [class.active]="editedTask.priority === 'low'"
                  (click)="setPriority('low')"
                >
                  Low <span class="icon">‚ñº</span>
                </button>
              </div>
            </div>

            <div class="form-group">
              <label>Assigned to</label>
              <app-contact-selector
                [selectedContactIds]="editedTask.assignedTo || []"
                (selectedContactsChange)="onContactsChange($event)"
              >
              </app-contact-selector>
            </div>


            <div class="subtasks-section">
              <span class="label">Subtasks</span>

              <div class="add-subtask">
                <input
                  type="text"
                  [(ngModel)]="newSubtaskTitle"
                  name="newSubtask"
                  placeholder="Add new subtask"
                  (keyup.enter)="addSubtask()"
                />
                <button
                  type="button"
                  class="reset-btn"
                  (click)="resetSubtaskInput()"
                  [class.visible]="newSubtaskTitle"
                >
                  ‚úï
                </button>
                <button type="button" class="add-btn" (click)="addSubtask()">‚úÖ</button>
              </div>

              <div class="subtasks-list">
                @if (editedTask.subtasks && editedTask.subtasks.length > 0) {
                  @for (subtask of editedTask.subtasks.slice(0, 3); track subtask; let i = $index) {
                    <div
                      class="subtask-item"
                      (mouseenter)="hoveredSubtaskIndex = i"
                      (mouseleave)="hoveredSubtaskIndex = null"
                    >
                      @if (editingSubtaskIndex === i) {
                        <input
                          type="text"
                          [(ngModel)]="editingSubtaskTitle"
                          (keyup.enter)="saveSubtaskEdit(i)"
                          (blur)="cancelSubtaskEdit()"
                          #subtaskInput
                          class="subtask-edit-input"
                        />
                      } @else {
 
                        <span class="subtask-title" [class.completed]="subtask.completed">
                          <strong>‚Ä¢</strong> {{ subtask.title }}
                        </span>

                        @if (hoveredSubtaskIndex === i) {
                          <div class="subtask-actions">
                            <button
                              class="edit-subtask"
                              (click)="
                                startSubtaskEdit(i, subtask.title);
                                $event.preventDefault();
                                $event.stopPropagation()
                              "
                            >
                              <span class="edit-icon">‚úèÔ∏è</span>
                            </button>

                            <button
                              class="delete-subtask"
                              (click)="
                                removeSubtask(i); $event.preventDefault(); $event.stopPropagation()
                              "
                            >
                              <span class="delete-icon">üóëÔ∏è</span>
                            </button>
                          </div>
                        }
                      }
                    </div>
                  }

                  @if (editedTask.subtasks.length > 3) {
                    <div class="more-subtasks">
                      <button
                        type="button"
                        class="more-btn"
                        (click)="showAllSubtasksEdit = !showAllSubtasksEdit"
                      >
                        <span class="plus-icon">{{ showAllSubtasksEdit ? '‚àí' : '+' }}</span>
                        <span>{{
                          showAllSubtasksEdit
                            ? 'Show less'
                            : editedTask.subtasks.length - 3 + ' more'
                        }}</span>
                      </button>
                    </div>
                  }

                  @if (showAllSubtasksEdit) {
                    <div class="extra-subtasks">
                      @for (
                        subtask of editedTask.subtasks.slice(3);
                        track subtask;
                        let i = $index
                      ) {
                        <div
                          class="subtask-item"
                          (mouseenter)="hoveredSubtaskIndex = i + 3"
                          (mouseleave)="hoveredSubtaskIndex = null"
                        >
                          @if (editingSubtaskIndex === i + 3) {
                            <input
                              type="text"
                              [(ngModel)]="editingSubtaskTitle"
                              (keyup.enter)="saveSubtaskEdit(i + 3)"
                              (blur)="cancelSubtaskEdit()"
                              class="subtask-edit-input"
                            />
                          } @else {
                            <input
                              type="checkbox"
                              [checked]="subtask.completed"
                              (change)="toggleSubtask(subtask)"
                              class="subtask-checkbox"
                            />
                            <span class="subtask-title" [class.completed]="subtask.completed">
                              {{ subtask.title }}
                            </span>

                            @if (hoveredSubtaskIndex === i + 3) {
                              <div class="subtask-actions">
                                <button
                                  class="edit-subtask"
                                  (click)="startSubtaskEdit(i + 3, subtask.title)"
                                >
                                  <span class="edit-icon">‚úèÔ∏è</span>
                                </button>
                                <button class="delete-subtask" (click)="removeSubtask(i + 3)">
                                  <span class="delete-icon">üóëÔ∏è</span>
                                </button>
                              </div>
                            }
                          }
                        </div>
                      }
                    </div>
                  }
                } @else {
                  <div class="empty-state">No subtasks</div>
                }
              </div>
            </div>

            <div class="edit-footer">
              <button type="button" class="cancel-btn" (click)="cancelEdit()">Cancel</button>
              <button type="submit" class="save-btn" [disabled]="taskForm.invalid || isSaving">
                {{ isSaving ? 'Saving...' : 'Ok ‚úì' }}
              </button>
            </div>

            @if (taskForm.invalid && taskForm.submitted) {
              <div class="form-error">Please fill all required fields correctly</div>
            }
          </div>
        </form>
      </div>
    }
  </div>
</div>
