<div class="overlay-backdrop" (click)="onClose()">
  <div class="task-overlay" (click)="$event.stopPropagation()">
    @if (!isEditMode && task) {
      <div class="task-view-container">
        <div class="overlay-header">
          <button class="close-btn" (click)="onClose()">✕</button>
          <div class="category-badge" [style.background-color]="categoryColor">
            {{ safeTask.category }}
          </div>
          <h1 class="task-title">
            {{ safeTask.title }}
          </h1>

          <p class="task-description">
            {{ safeTask.description }}
          </p>
        </div>

        <div class="overlay-content">
          <div class="info-grid">
            <div class="info-row">
              <span class="label">Due date:</span>
              <span class="value">{{ safeTask.dueDate | date: 'dd/MM/yyyy' }}</span>
            </div>

            <div class="info-row">
              <span class="label">Priority:</span>
              <div class="priority-badge" [ngClass]="safeTask.priority">
                <span class="priority-icon">
                  <div class="priority-badge" [class]="safeTask.priority">
                    <span>{{ safeTask.priority | titlecase }}</span>
                    <img
                      [src]="'assets/imgs/add-task/' + safeTask.priority + '_default.png'"
                      [alt]="safeTask.priority"
                    />
                  </div>
                </span>
              </div>
            </div>
          </div>

          <div class="assigned-section">
            <span class="label">Assigned To:</span>
            <div class="contacts-list">
              @if (assignedContacts && assignedContacts.length > 0) {
                <div class="assigned-list scrollable">
                  @for (contact of assignedContacts; track contact.id) {
                    <div class="assigned-item">
                      <div class="avatar" [style.background-color]="getContactColor(contact)">
                        {{ getInitials(contact.name) }}
                      </div>
                      <span class="contact-name">{{ contact.name }}</span>
                    </div>
                  }
                </div>
              } @else {
                <div class="empty-state">No contacts assigned</div>
              }
            </div>
          </div>

          <div class="form-group">
            <label>Subtasks</label>
            @if (safeTask.subtasks && safeTask.subtasks.length > 0) {
              <div class="subtasks-list">
                @for (subtask of safeTask.subtasks; track subtask; let i = $index) {
                  <div class="subtask-item">
                    <input
                      type="checkbox"
                      [checked]="subtask.completed"
                      (change)="toggleSubtask(subtask)"
                      class="subtask-checkbox"
                    />
                    <span class="subtask-title" [class.completed]="subtask.completed">
                      {{ subtask.title }}
                    </span>
                  </div>
                }
              </div>
            } @else {
              <div class="empty-state">No subtasks</div>
            }
          </div>
        </div>

        <div class="overlay-footer">
          <button class="delete-btn" (click)="onDelete()">
            <img
              src="assets/icon/contact-info/delete-default.png"
              alt="Delete"
              class="btn-icon"
              (mouseenter)="deleteHover = true"
              (mouseleave)="deleteHover = false"
              [src]="
                deleteHover
                  ? 'assets/icon/contact-info/delete-hover.png'
                  : 'assets/icon/contact-info/delete-default.png'
              "
            />
            Delete
          </button>
          <div class="divider"></div>
          <button class="edit-btn" (click)="enableEdit()">
            <img
              src="assets/icon/contact-info/edit-default.png"
              alt="Edit"
              class="btn-icon"
              (mouseenter)="editHover = true"
              (mouseleave)="editHover = false"
              [src]="
                editHover
                  ? 'assets/icon/contact-info/edit-hover.png'
                  : 'assets/icon/contact-info/edit-default.png'
              "
            />
            Edit
          </button>
        </div>
      </div>
    }

    @if (isEditMode && task) {
      <div class="task-edit-container">
        <div class="overlay-header">
          <button class="close-btn" (click)="cancelEdit()">✕</button>
        </div>

        <div class="overlay-content">
          <form #taskForm="ngForm" (ngSubmit)="onSave()" novalidate>
            <div class="form-group" [class.has-error]="title.invalid && title.touched">
              <label>Title</label>
              <input
                type="text"
                [(ngModel)]="editedTask.title"
                name="title"
                #title="ngModel"
                required
                placeholder="Enter task title"
              />
              @if (title.invalid && title.touched) {
                <small class="error-message">Title is required</small>
              }
            </div>

            <div class="form-group">
              <label>Description</label>
              <textarea
                [(ngModel)]="editedTask.description"
                name="description"
                #description="ngModel"
                placeholder="Enter task description"
              ></textarea>
            </div>

            <div class="form-group" [class.has-error]="dueDate.invalid && dueDate.touched">
              <label>Due date</label>
              <input
                type="date"
                [(ngModel)]="editedTask.dueDate"
                name="dueDate"
                #dueDate="ngModel"
                required
                [min]="today"
              />
              @if (dueDate.invalid && dueDate.touched) {
                @if (dueDate.errors?.['required']) {
                  <small class="error-message">Due date is required</small>
                }
                @if (dueDate.errors?.['min']) {
                  <small class="error-message">Due date must be in the future</small>
                }
              }
            </div>

            <div class="form-group">
              <label>Priority</label>
              <div class="priority-buttons">
                <button
                  type="button"
                  class="priority urgent"
                  [class.active]="editedTask.priority === 'urgent'"
                  (click)="setPriority('urgent')"
                >
                  <span>Urgent</span>
                  <img
                    [attr.src]="
                      editedTask.priority === 'urgent'
                        ? 'assets/imgs/add-task/urgent_white.png'
                        : 'assets/imgs/add-task/urgent_default.png'
                    "
                    alt="Urgent"
                  />
                </button>

                <button
                  type="button"
                  class="priority medium"
                  [class.active]="editedTask.priority === 'medium'"
                  (click)="setPriority('medium')"
                >
                  <span>Medium</span>
                  <img
                    [attr.src]="
                      editedTask.priority === 'medium'
                        ? 'assets/imgs/add-task/medium_white.png'
                        : 'assets/imgs/add-task/medium_default.png'
                    "
                    alt="Medium"
                  />
                </button>

                <button
                  type="button"
                  class="priority low"
                  [class.active]="editedTask.priority === 'low'"
                  (click)="setPriority('low')"
                >
                  <span>Low</span>
                  <img
                    [attr.src]="
                      editedTask.priority === 'low'
                        ? 'assets/imgs/add-task/low_white.png'
                        : 'assets/imgs/add-task/low_default.png'
                    "
                    alt="Low"
                  />
                </button>
              </div>
            </div>

            <div class="form-group">
              <label>Assigned to</label>
              <app-contact-selector
                [selectedContactNames]="editedTask.assignedTo || []"
                (selectedContactsChange)="onContactsChange($event)"
                [showAsList]="false"
                [showCheckboxes]="true"
              >
              </app-contact-selector>
            </div>

            <div class="subtasks-section">
              <span class="label">Subtasks</span>

              <div class="subtask-input">
                <input
                  type="text"
                  placeholder="Add new subtask"
                  [(ngModel)]="newSubtaskTitle"
                  name="newSubtask"
                  (keyup.enter)="addSubtask()"
                  (click)="$event.stopPropagation()"
                />

                @if (newSubtaskTitle.trim().length > 0) {
                  <div class="subtask-actions">
                    <img
                      src="assets/imgs/add-task/delete_grey.png"
                      alt="Clear subtask"
                      class="subtask-icon delete"
                      (mousedown)="$event.preventDefault()"
                      (click)="resetSubtaskInput()"
                    />
                    <div class="subtask-divider"></div>
                    <img
                      src="assets/imgs/add-task/check_grey.png"
                      alt="Add subtask"
                      class="subtask-icon check"
                      (mousedown)="$event.preventDefault()"
                      (click)="addSubtask()"
                    />
                  </div>
                }
              </div>

              <div class="subtasks-list">
                @if (editedTask.subtasks && editedTask.subtasks.length > 0) {
                  @for (subtask of editedTask.subtasks; track subtask; let i = $index) {
                    <div
                      class="subtask-item"
                      [class.editing]="editingSubtaskIndex === i"
                      (mouseenter)="hoveredSubtaskIndex = i"
                      (mouseleave)="hoveredSubtaskIndex = null"
                    >
                      @if (editingSubtaskIndex === i) {
                        <div class="subtask-input existing-subtask">
                          <div class="subtask-content">
                            <span class="subtask-bullet">•</span>
                            <input
                              type="text"
                              [(ngModel)]="editingSubtaskTitle"
                              (click)="$event.stopPropagation()"
                              (keyup.enter)="saveSubtaskEdit(i)"
                            />
                          </div>
                          <div class="subtask-actions">
                            <img
                              src="assets/imgs/add-task/trash.png"
                              alt="Delete subtask"
                              class="subtask-icon delete"
                              (mousedown)="$event.preventDefault()"
                              (click)="$event.stopPropagation(); removeSubtask(i)"
                            />
                            <div class="subtask-divider"></div>
                            <img
                              src="assets/imgs/add-task/check_grey.png"
                              alt="Save subtask"
                              class="subtask-icon check"
                              (mousedown)="$event.preventDefault()"
                              (click)="$event.stopPropagation(); saveSubtaskEdit(i)"
                            />
                          </div>
                        </div>
                      } @else {
                        <div class="subtask-content">
                          <span class="subtask-bullet">•</span>
                          <span class="subtask-title-text">{{ subtask.title }}</span>
                        </div>

                        @if (hoveredSubtaskIndex === i) {
                          <div class="subtask-actions">
                            <img
                              src="assets/icon/contact-info/edit-default.png"
                              alt="Edit subtask"
                              class="subtask-icon edit"
                              (mousedown)="$event.preventDefault()"
                              (click)="$event.stopPropagation(); startSubtaskEdit(i, subtask.title)"
                            />
                            <div class="subtask-divider"></div>
                            <img
                              src="assets/imgs/add-task/trash.png"
                              alt="Delete subtask"
                              class="subtask-icon delete"
                              (mousedown)="$event.preventDefault()"
                              (click)="$event.stopPropagation(); removeSubtask(i)"
                            />
                          </div>
                        }
                      }
                    </div>
                  }
                } @else {
                  <div class="empty-state">No subtasks</div>
                }
              </div>
            </div>
          </form>
        </div>
        <div class="overlay-footer">
          <button
            type="button"
            class="save-btn"
            (click)="taskForm.ngSubmit.emit()"
            [disabled]="taskForm.invalid || isSaving"
          >
            {{ isSaving ? 'Saving...' : 'Ok ✓' }}
          </button>
        </div>
      </div>
    }
  </div>
</div>
