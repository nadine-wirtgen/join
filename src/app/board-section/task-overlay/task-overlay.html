<div class="overlay-backdrop" (click)="onClose()">
  <div class="task-overlay" (click)="$event.stopPropagation()">
    @if (!isEditMode && task) {
      <div class="task-view-container">
        <div class="overlay-header">
          <button class="close-btn" (click)="onClose()">‚úï</button>
          <div class="category-badge" [style.background-color]="categoryColor">
            {{ safeTask.category }}
          </div>
          <h1 class="task-title">
            {{ safeTask.title | slice: 0 : 25 }}{{ safeTask.title.length > 25 ? '...' : '' }}
          </h1>

          <p class="task-description">
            {{ safeTask.description | slice: 0 : 50
            }}{{ safeTask.description.length > 50 ? '...' : '' }}
          </p>
        </div>

        <div class="overlay-content">
          <div class="info-grid">
            <div class="info-row">
              <span class="label">Due date:</span>
              <span class="value">{{ safeTask.dueDate | date: 'dd/MM/yyyy' }}</span>
            </div>

            <div class="info-row">
              <span class="label">Priority:</span>
              <div class="priority-badge" [ngClass]="safeTask.priority">
                <span class="priority-icon">
                  <div class="priority-badge" [class]="safeTask.priority">
                    <span>{{ safeTask.priority | titlecase }}</span>
                    <img
                      [src]="'assets/imgs/add-task/' + safeTask.priority + '_default.png'"
                      [alt]="safeTask.priority"
                    />
                  </div>
                </span>
              </div>
            </div>
          </div>

          <div class="assigned-section">
            <span class="label">Assigned To:</span>
            <div class="contacts-list">
              @if (assignedContacts && assignedContacts.length > 0) {
                <div class="assigned-list scrollable">
                  @for (contact of assignedContacts; track contact.id) {
                    <div class="assigned-item">
                      <div class="avatar" [style.background-color]="getContactColor(contact)">
                        {{ getInitials(contact.name) }}
                      </div>
                      <span class="contact-name">{{ contact.name }}</span>
                    </div>
                  }
                </div>
              } @else {
                <div class="empty-state">No contacts assigned</div>
              }
            </div>
          </div>

          <div class="form-group">
            <label>Subtasks</label>
            @if (safeTask.subtasks && safeTask.subtasks.length > 0) {
              <div class="subtasks-list">
                @for (subtask of safeTask.subtasks; track subtask; let i = $index) {
                  <div class="subtask-item">
                    <input
                      type="checkbox"
                      [checked]="subtask.completed"
                      (change)="toggleSubtask(subtask)"
                      class="subtask-checkbox"
                    />
                    <span class="subtask-title" [class.completed]="subtask.completed">
                      {{ subtask.title }}
                    </span>
                  </div>
                }
              </div>
            } @else {
              <div class="empty-state">No subtasks</div>
            }
          </div>
        </div>

        <div class="overlay-footer">
          <button class="delete-btn" (click)="onDelete()">
            <span class="btn-icon">üóë</span>
            Delete
          </button>
          <div class="divider"></div>
          <button class="edit-btn" (click)="enableEdit()">
            <span class="btn-icon">‚úè</span>
            Edit
          </button>
        </div>
      </div>
    }

    @if (isEditMode && task) {
      <div class="task-edit-container">
        <div class="overlay-header">
          <button class="close-btn" (click)="cancelEdit()">‚úï</button>
          <h2 class="edit-title">Edit Task</h2>
        </div>

        <div class="overlay-content">
          <form #taskForm="ngForm" (ngSubmit)="onSave()" novalidate>
            <div class="form-group" [class.has-error]="title.invalid && title.touched">
              <label>Title <span class="required">*</span></label>
              <input
                type="text"
                [(ngModel)]="editedTask.title"
                name="title"
                #title="ngModel"
                required
                placeholder="Enter task title"
              />
              @if (title.invalid && title.touched) {
                <small class="error-message">Title is required</small>
              }
            </div>

            <div class="form-group">
              <label>Description</label>
              <textarea
                [(ngModel)]="editedTask.description"
                name="description"
                #description="ngModel"
                placeholder="Enter task description"
              ></textarea>
            </div>

            <div class="form-group" [class.has-error]="dueDate.invalid && dueDate.touched">
              <label>Due date <span class="required">*</span></label>
              <input
                type="date"
                [(ngModel)]="editedTask.dueDate"
                name="dueDate"
                #dueDate="ngModel"
                required
                [min]="today"
              />
              @if (dueDate.invalid && dueDate.touched) {
                @if (dueDate.errors?.['required']) {
                  <small class="error-message">Due date is required</small>
                }
                @if (dueDate.errors?.['min']) {
                  <small class="error-message">Due date must be in the future</small>
                }
              }
            </div>

            <div class="form-group">
              <label>Priority</label>
              <div class="priority-buttons">
                <button
                  type="button"
                  class="priority urgent"
                  [class.active]="editedTask.priority === 'urgent'"
                  (click)="setPriority('urgent')"
                >
                  <span>Urgent</span>
                  <img
                    [attr.src]="
                      editedTask.priority === 'urgent'
                        ? 'assets/imgs/add-task/urgent_white.png'
                        : 'assets/imgs/add-task/urgent_default.png'
                    "
                    alt="Urgent"
                  />
                </button>

                <button
                  type="button"
                  class="priority medium"
                  [class.active]="editedTask.priority === 'medium'"
                  (click)="setPriority('medium')"
                >
                  <span>Medium</span>
                  <img
                    [attr.src]="
                      editedTask.priority === 'medium'
                        ? 'assets/imgs/add-task/medium_white.png'
                        : 'assets/imgs/add-task/medium_default.png'
                    "
                    alt="Medium"
                  />
                </button>

                <button
                  type="button"
                  class="priority low"
                  [class.active]="editedTask.priority === 'low'"
                  (click)="setPriority('low')"
                >
                  <span>Low</span>
                  <img
                    [attr.src]="
                      editedTask.priority === 'low'
                        ? 'assets/imgs/add-task/low_white.png'
                        : 'assets/imgs/add-task/low_default.png'
                    "
                    alt="Low"
                  />
                </button>
              </div>
            </div>

            <div class="form-group">
              <label>Assigned to</label>
              <app-contact-selector
                [selectedContactNames]="editedTask.assignedTo || []"
                (selectedContactsChange)="onContactsChange($event)"
                [showAsList]="false"
                [showCheckboxes]="true"
              >
              </app-contact-selector>
            </div>

            <div class="subtasks-section">
              <span class="label">Subtasks</span>

              <div class="add-subtask">
                <input
                  type="text"
                  [(ngModel)]="newSubtaskTitle"
                  name="newSubtask"
                  placeholder="Add new subtask"
                  (keyup.enter)="addSubtask()"
                />
                <button
                  type="button"
                  class="reset-btn"
                  (click)="resetSubtaskInput()"
                  [class.visible]="newSubtaskTitle"
                >
                  ‚úï
                </button>
                <button type="button" class="add-btn" (click)="addSubtask()">‚úÖ</button>
              </div>

              <div class="subtasks-list">
                @if (editedTask.subtasks && editedTask.subtasks.length > 0) {
                  @for (subtask of editedTask.subtasks; track subtask; let i = $index) {
                    <div
                      class="subtask-item"
                      (mouseenter)="hoveredSubtaskIndex = i"
                      (mouseleave)="hoveredSubtaskIndex = null"
                    >
                      @if (editingSubtaskIndex === i) {
                        <input
                          type="text"
                          [(ngModel)]="editingSubtaskTitle"
                          (keyup.enter)="saveSubtaskEdit(i)"
                          (blur)="cancelSubtaskEdit()"
                          #subtaskInput
                          class="subtask-edit-input"
                        />
                      } @else {
                        <span class="subtask-title"> <strong>‚Ä¢</strong> {{ subtask.title }} </span>

                        @if (hoveredSubtaskIndex === i) {
                          <div class="subtask-actions">
                            <button
                              class="edit-subtask"
                              (click)="
                                startSubtaskEdit(i, subtask.title);
                                $event.preventDefault();
                                $event.stopPropagation()
                              "
                            >
                              <span class="edit-icon">‚úèÔ∏è</span>
                            </button>

                            <button
                              class="delete-subtask"
                              (click)="
                                removeSubtask(i); $event.preventDefault(); $event.stopPropagation()
                              "
                            >
                              <span class="delete-icon">üóëÔ∏è</span>
                            </button>
                          </div>
                        }
                      }
                    </div>
                  }
                } @else {
                  <div class="empty-state">No subtasks</div>
                }
              </div>
            </div>
          </form>
        </div>
        <div class="overlay-footer">
          <button
            type="button"
            class="save-btn"
            (click)="taskForm.ngSubmit.emit()"
            [disabled]="taskForm.invalid || isSaving"
          >
            {{ isSaving ? 'Saving...' : 'Ok ‚úì' }}
          </button>
        </div>
      </div>
    }
  </div>
</div>
